!function(h){var l="undefined"==typeof imageManagerTitle;h("#image,#input-image").closest("tr,.form-group").remove();var o,s=pimJson,r=[480,720,1080,2048,4096,8400,10240,"original"],f=!0,i=[],t=h("#file-input"),e=h("#drop-files p"),m="#list-view",v=!1,w=y("images_path"),b=0;function y(e,t){if(void 0!==t&&void 0!==s[e]){if(void 0!==s[e][t])return s[e][t]}else if(void 0!==s[e])return s[e];return t||e}function d(){if(!((o=h(m+" .image").length)<y("content","max_images")))return h("#drop-files p").html(y("lang","u_up_max")+" "+y("content","max_images")+" "+y("lang","images")+"!").css("color","#fd8b8b"),1;e.attr("style")&&e.html(y("lang","dad_an_image")).attr("style","")}function x(e,t){var a="";if(e=e.replace(/(\#|\%|\&| )/g,"-"),"default"===t){var i=175-e.length;return a=i<0?e.slice(0,i):e}var n=y("content","translit_map");if("random"===t){for(var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=0;s<e.length+25&&!(175<s);s++)a+=o.charAt(Math.floor(Math.random()*o.length));return a}if(/[^\u0000-\u007f]/.test(e)&&/\{.\}/.test(n)){for(var r,s=0;s<e.length&&!(175<s);s++){"~!@$^()_-+={}][".indexOf(e[s])<0&&(r=new RegExp("(\\w+)\\{(\\p{L}|\\d)*"+e[s]+"(\\p{L}|\\d)*\\}","ui")),(matches=n.match(r))?a+=matches[1]:/[\w-()]/.test(e[s])?a+=e[s]:a+="-"}return delete matches,a}return e}function _(e,t,a,i,n,o,s){if(void 0===o&&(o=.99),"original"===t&&.99<=o&&!n)return s;var r=a.width,l=a.height,d=document.createElement("canvas");"original"!==t&&a.height>t&&(r=a.width*t/a.height,l=t),d.width=r,d.height=l;var c=d.getContext("2d");c.drawImage(a,0,0,r,l),/blob:|wm_bg|base64/.test(a.src)&&n&&function(e,t){if(!t||""==t.text||!t.image)return;e.drawWatermark=function(e,t,a,i){i=parseInt(i)/100;var n=this.width/100,o=Math.min((this.width-2*n)/e.width,this.height/e.height)*i;if(e.width*=o,e.height*=o,this.context.globalAlpha=parseInt(a)/100,"center"==t)var s=(this.width-e.width)/2,r=(this.height-e.height)/2;else{if("multiple"==t){for(var l=parseInt(this.width/e.width),d=parseInt(this.height/e.height),c=0;c<=d;c++)for(var r=c*e.height*1.5,m=0;m<=l;m++){s=e.width*m*1.5+(c%2?e.width/2:0);this.context.drawImage(e,s,r,e.width,e.height)}return}s=/right$/.test(t)?this.width-e.width-n:n,r=/^bottom/.test(t)?this.height-e.height:0}this.context.drawImage(e,s,r,e.width,e.height)};try{t.image.complete?e.drawWatermark(t.image,t.position,t.opacity,t.size):(t.image.onload=function(){e.drawWatermark(t.image,t.position,t.opacity,t.size)},t.image.onerror=function(){return k(" "+y("lang","watermark_not_found"),"danger",h("#watermark > .row")[0]),!1})}catch(e){k(" "+y("lang","watermark_not_found"),"danger",h("#watermark > .row")[0])}}({context:c,width:r,height:l},n);var m,u="image/"+("jpg"==e?"jpeg":e),p=i?d:d.toDataURL(u,o);return s&&1.01*s.size<3*p.length/4&&(m=d.toDataURL(u,0).length,p=d.toDataURL(u,1-m/s.size)),p}function n(e){if(0!=e.length&&f&&!(o>=y("content","max_images"))){f=!1;var t=[],a={imageName:y("content","image_name"),quality:(100-y("content","image_quality")+1)%101/100%1||.99,size:r[y("content","image_size")]};v&&o||(v=function(){var e=y("content","upload_folder");e=(e=e.replace(/\{(.*?)\}/g,function(e,t){if("year"===t||"month"===t||"day"===t)return y(t);if("manufacturer"===t){var a=h("[name ^="+t+"]");if(a[1]&&0!=a[1].value)return a[0].value;if(0!=a[0].value&&"SELECT"===a[0].tagName)return a[0].querySelector("option:checked").text}else try{if(val=h("[name ="+t+"]").val())return val.toLowerCase()}catch(e){}return"undefined"})).split("|");for(var t=0;t<e.length;t++){if(!/[^\u0000-\u007f]|undefined/.test(e[t])){e=e[t]?e[t]+"/":"";break}e.length===t+1&&(e="")}return(l?"catalog/":"data/")+e.replace(/(\#|\%|\&| )/g,"-")}(),h(m+">input.img-input").remove());for(var i,n=0;n<e.length;n++){if(/(\.(jpe?g|png|gif|bmp)$)/i.test(e[n].name||e[n])&&(i=h('<div class ="loaderImg image" ><div class="loading"><div></div><span>'+y("lang","loading")+"...</span></div></div>"),e[n].src||"string"==typeof e[n]?t.push({imageBlock:i,url:e[n].src||e[n],name:e[n].name||e[n].replace(/.*\//,"")}):(e[n].imageBlock=i,t.push(e[n])),h(m).append(document.createTextNode("\n")),h(m).append(i)),d())break}!function n(r,l){if(0==r.length)return void(f=!0);var e=new Image,d=r.shift(),c="new",m=d.imageBlock,t=d.name.split(/\.(?=[^.]*$)/),u=/png|gif/i.test(t[1])?t[1]:"jpg",p=x(t[0],l.imageName)+"."+u,g=v+p;e.onerror=function(e){k('  "'+p+'" - '+y("lang","image_damaged"),"danger"),m.remove(),n(r,l)};e.onload=function(){var e,o,s,t;"new"==c&&(e="on"===y("content","watermark_status")&&y("content","watermark"),"random"!==l.imageName&&(o=u,s=m,t=g,h.ajax({url:"index.php?route=catalog/product/imageExist"+y("token"),type:"POST",contentType:"application/x-www-form-urlencoded",data:{name:t},success:function(e){var t,a,i,n;0!=e.status&&(t=new Image,a=s.find(".img-input").val(),(i=document.createElement("div")).className="aExist",n='<img src="" class="ui-sortable-handle" ><p class="e_text">'+y("lang","exist")+"</p>",n+='<p class="e_bottom"><button id="keep" type="button" class="btn btn-default keep_both">'+y("lang","keep_both")+"</button>",n+='<button id="rep" type="button" class="btn btn-default">'+y("lang","replace")+"</button>",n+='<button id="skip" type="button" class="btn btn-default">'+y("lang","keep_old")+"</button></p>",i.innerHTML=n,s.append(i),t.onload=function(){h(i).show("fast"),h("img",i).attr("src",_(o,200,this,!1))},t.src=w+a,h("button",i).one("click",function(){h(i).hide("fast"),"skip"==this.id?s.removeData("upl").find(".previewImg").html("<img src='"+_(o,200,t,!1)+"' />"):"keep"==this.id&&(s.data("upl").name=e.newname,s.find(".img-input").val(a.match(/.*\//)+e.newname)),setTimeout(function(){h(i).remove()},200)})),b--}}),b++),m.data("upl",{name:p,type:u,value:_(u,l.size,this,!1,e,l.quality,d)}));var a=_(u,200,this,!1,e,l.quality);m.html("<span class='previewImg'></span>").removeClass("loaderImg").addClass(c),m.find(".previewImg").append("<img src='"+a+"' />");var i='<span  class="btm_img ">';i+='<i class="fa fa-search-plus" data-toggle="tooltip" aria-hidden="true" data-original-title ="'+y("lang","zoom")+'" ></i>',i+='<i class="fa fa-times" data-toggle="tooltip" aria-hidden="true" data-original-title ="'+y("lang","delete")+'" ></i>',i+='<i class="fa fa-del-all fa-flip-horizontal" data-toggle="tooltip" aria-hidden="true" data-original-title ="'+y("lang","delete_all")+'" ></i>',i+="</span>",i+="<input "+(m.prev().length?"":'id="input-image"')+' value="'+g+'" class = "img-input" type="hidden" >',m.append(i),window.poipInstalled&&poip.product_options.length&&poip.showImages(m,r.length),setTimeout(function(){n(r,l)},20)};d.type?(window.URL=window.URL||window.webkitURL,e.src=window.URL.createObjectURL(d)):(e.src=d.url,-1!=d.url.indexOf(w)&&(e.src=d.url,c="old",g=d.url.replace(w,"")))}(t,a)}}h(m).tooltip({selector:".image i",container:"body"}),h.event.props.push("dataTransfer"),h("body").bind({drop:function(){return!1},dragover:function(e){return!1}}),h(function(){var n=!1,i=0,a=0;function o(e){ds=h(document).scrollTop(),ds>=e-i&&0<n||ds<=a&&n<0?n=!1:n&&(h(document).scrollTop(ds+n),setTimeout(o,100))}h(m).sortable({scroll:!1,handle:".previewImg",start:function(e,t){t.item.addClass("mouseScale"),dh=h(document).height(),a=h(m).offset().top-50,i=h(window).height()},sort:function(e,t){h(document).scrollTop();var a=e.pageY-window.pageYOffset;n=i-30<=a?5:a<=30&&-5,o(dh)},deactivate:function(e,t){var a,i=h("#input-image");i.length&&i.closest(".image").prev().length&&(h(".image .img-input")[0].id="input-image",i[0].id=""),!window.poipInstalled||(a=h(".image")[0])!=notPoipModImage&&(notPoipModImage.appendChild(a.querySelector(".poip-mod")),notPoipModImage=a),setTimeout(function(){t.item.removeClass("mouseScale tapScale")},10),n=!1}}),h(m).disableSelection()}),h("body").bind("drop dragover dragleave",function(e){(h("#tab-image.active").length||h('[href="#tab-image"].selected').length)&&("dragover"==e.type?(e.preventDefault(),h(this).attr("class","dropHover")):("drop"==e.type&&n(e.dataTransfer.files),h(this).removeAttr("class","dropHover")))}),t.on("change",function(e){n(h(this)[0].files),t.replaceWith(t=t.val("").clone(!0))}),h(document).on("touchstart touchmove touchend touchcancel",m+" .previewImg",function(e){return"touchstart"==e.type?(stra=0,ssd=setTimeout(function(){h(e.target).parent().addClass("tapScale"),h(document).trigger("touchstart"),p(e),stra=1},200)):"touchend"!=e.type&&"touchmove"!=e.type||clearTimeout(ssd),0==stra?void 0:(p(e),void("touchend"==e.type&&h(this).parent().removeClass("tapScale")))}),d();var a,c=[];multipleAddImages=function(e){var t=l?"":"data/";if("object"==typeof e){var a,i=l?e.parent().find("input"):e.find("input"),n=w+t+i.val();l&&i.click(),-1!=(a=h.inArray(n,c))?(c.splice(a,1),l&&e.removeClass("seBor")):y("content","max_images")>c.length&&(c.push(n),l&&e.addClass("seBor"))}else if("other_dir"==e)for(var o=0;o<c.length;o++){var s=h(l?'#modal-image a[href="'+c[o]+'"]':'#modal-image #column-right input[value="'+c[o].replace(w+t,"")+'"]');s.length&&(l?s.addClass("seBor").next().children().prop("checked",!0):s.parent().addClass("selected"))}var r='<button type="button" data-toggle="tooltip" title="" id="multi_add" class="btn btn-success" data-original-title="'+y("lang","mAdd")+'">';r+='<i class="fa fa-check"></i><span>'+c.length+"</span></button>",h("#multi_add").remove(),0<c.length&&h("#modal-image "+(l?"#button-delete":"#refresh")).after(r)},fmHTML=function(e,t){var a;return e=e.replace(/(\$\(\'#(.*?)delete\'\)\.(bind|on).*?\{)([\s\S]*?\(json(\.|\[')success.+?{)/g,"$1 $('#multi_add').addClass('hidden');$4 $('.pim-fm  #column-right a.selected,.pim-fm input[name^=path]:checked').each(function(e){multipleAddImages($(this));});$('#multi_add').removeClass('hidden');"),e=l?e.replace("$('#modal-image').modal('hide');",""):(a='<div class="modal-dialog modal-lg im-oc15"><div  class="modal-content">',a+='<div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>',(a+='<h4 class="modal-title">'+imageManagerTitle+"</h4></div>")+'<div class="modal-body">'+(e=(e=(e=(e=(e=e.replace("$('#column-right a').removeAttr('class');","")).replace("if ($(this).attr('class') == 'selected')","multipleAddImages($(this));if ($(this).attr('class') == 'selected')")).replace("$('#column-right').html(html);","$('#column-right').html(html);multipleAddImages('other_dir');")).replace("$(element).offset();","$(element).position();")).replace(/\<style[\s\S]*?\/style>/g,""))+"</div></div></div>"),e=t?e:'<div id="modal-image" class="modal pim-fm">'+e+"</div>"},h(document).on("ajaxComplete",function(e,t,a){h(".pim-fm:visible").length&&void 0===a.pimFileManager&&"GET"===a.type&&/filemanager/.test(a.url)&&(h(".pim-fm").html(fmHTML(t.responseText,!0)),multipleAddImages("other_dir"))}),h("#bySer").on("click",function(){var t=h(this);t.prop("disabled",!0);var a=h("i",this);a.attr("class","fa fa-circle-o-notch fa-spin"),c=[],h(".im-oc15").length?(h("#modal-image #column-right a.selected").removeClass("selected"),h("#multi_add").remove(),h(".pim-fm").modal("show"),t.prop("disabled",!1),a.attr("class","fa fa-cloud")):(h("#modal-image").remove(),h.ajax({pimFileManager:!0,url:"index.php?route=common/filemanager"+y("token"),dataType:"html",success:function(e){h("body").append(fmHTML(e)),h("#modal-image").modal("show"),h("#modal-image").on("click","a,#multi_add",function(e){h(this).is(".thumbnail")&&l?(e.preventDefault(),multipleAddImages(h(this))):h(this).is("#multi_add")&&f&&(h("#modal-image").modal("hide"),n(c))}),t.prop("disabled",!1),a.attr("class","fa fa-cloud")}}))}),h("#byUrl").click(function(){h("#url-input span").toggle("fast")}),h("#url-input button").on("click",function(){var e=h("#url-input input").val().replace(/ /g,"").split("#"),i=[];h("#url-input").append("<i></i>");var t=e.length;setTimeout(function(){h("#url-input i")[0]&&(h("#url-input i")[0].style.width=97/t+"%")},200),function t(a){if(!a--)return h("#url-input i").remove(),h("#url-input input").val(""),h("#url-input span").toggle("fast"),void n(i);e[a]?h.ajax({url:"index.php?route=catalog/product/encodeLinkImage"+y("token"),type:"POST",contentType:"application/x-www-form-urlencoded",data:{urls:e[a]},success:function(e){e=JSON.parse(e),h("#url-input i")[0].style.width=97/a+"%",i.push(e),t(a)}}):t(a)}(t)}),h(m).on("click",".image i.fa-times",function(){var e=h(this).closest(".image"),t=e.find(".img-input").val();f&&(h(".tooltip").length&&h(".tooltip").remove(),e.is(".old")&&""!=t&&1<y("content","remove_images")&&i.push(t),e.hide("fast",function(){this.remove(),d()}))}),h(m).on("mouseover mouseout",".image i.fa-times",function(e){null!==e.target.parentNode.parentNode.nextElementSibling&&("mouseover"===e.type&&e.target.className.indexOf(" show-del-all")<0?a=setTimeout(function(){e.target.className+=" show-del-all"},200):(clearTimeout(a),e.target.className=e.target.className.replace(" show-del-all","")))}),h(m).on("click",".image .fa-del-all",function(){var e=h(this).closest(".image");e.nextAll().find("i.fa-times").click(),e.find("i.fa-times").click()});var u=document.querySelector('a[onclick="$(\'#form\').submit();"],button[type="submit"][form="form-product"]');function p(e){var t=e.originalEvent.changedTouches[0],a=document.createEvent("MouseEvent");a.initMouseEvent({touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"}[e.type],!0,!0,window,1,t.screenX,t.screenY,t.clientX,t.clientY,!1,!1,!1,!1,0,null),t.target.dispatchEvent(a),e.preventDefault()}u.parentNode.style="position: relative;",u.setAttribute("type",""),u.setAttribute("onclick",""),u.onclick=function(e){h(".modal form").remove(),e.preventDefault(),f&&imagesUpload(!1)},h("#qsave").on("mousedown",function(e){imagesUpload("before")}),h(document).on("ajaxComplete",function(e,t,a){a.url&&/qsave/.test(a.url)&&imagesUpload(!0)}),window.imagesUpload=function(e){if(h(".keep_both").click(),h.each(h(m).children(),function(e,t){var a="<input class = 'img-input' name='"+(0==e?"image":"product_image["+e+"][image]")+"' value='"+h(this).find(".img-input").val()+"'  type='hidden' >";if(a+=0==e?"":"\n<input name='product_image["+e+"][sort_order]' value='"+e+"' type='hidden' >",h("input:not([type=checkbox])",this).remove(),h(this).append(a),window.poipInstalled)for(var i=h(this).find("input[type=checkbox]"),n=0;n<i.length;n++)i[n].name=i[n].name.replace("index",e)}),o||h(m).html('<input name="image" class = "img-input" type="hidden" >'),"before"===e)return!0;0!=b?(h("button[type=submit]").addClass("shkMe").after("<span  class = 'moment' style='text-align:center;position: absolute;background: #ffffff;border: 1px solid #000;padding: 3px;border-radius: 2px;line-height: 1.2;'>One sec.!</span>"),setTimeout(function(){h("button[type=submit]").removeClass("shkMe").next().remove()},500)):(f=!1,function(a){var r={},l=new FormData;if(h(m+" .new").each(function(e,t){var a=h(this).data("upl");if(a&&!r[a.name]&&a.type){if("object"==typeof a.value)var i=a.value;else{for(var n=atob(a.value.split(",")[1]),o=[],s=0;s<n.length;s++)o.push(n.charCodeAt(s));i=new Blob([new Uint8Array(o)],{type:"image/"+a.type})}l.append(e,i,a.name),r[a.name]=!0,r[0]||(r[0]="image")}this.className=this.className.replace("new","old"),h(this).removeData("upl")}),i.length){for(var e=h("[id^=input-description], .old .img-input").map(function(){return this.value.match(new RegExp(w+"(.*?.(jpe?g|png|gif|bmp))","g"))||this.value}),t=0;t<i.length;t++)-1==h.inArray(i[t],e)&&(l.append("dels[value][]",i[t]),r[0]&&"image"!==r[0]||(l.append("dels[id]",y("product_id")),r[0]=r[0]?"image + delete":"delete"));i=[]}l.append("catalog",v),r[0]?h.ajax({async:!0,contentType:!1,data:l,processData:!1,type:"post",url:"index.php?route=catalog/product/uploadNewImage"+y("token"),xhr:function(){var e,t,a=h.ajaxSettings.xhr();return-1<r[0].indexOf("image")&&((e=document.createElement("div")).innerHTML='<div><span>Upload...</span><div class ="upload-view-bg"></div></div>',e.className="upload-view",u.parentNode.appendChild(e),t=e.getElementsByClassName("upload-view-bg"),a.upload.onprogress=function(e){t[0].style.width=parseInt(100.1/e.total*e.loaded)+"%"}),a},success:function(e){var t=document.querySelector(".upload-view");t&&t.parentNode.removeChild(t),f=!0,a||h("form").submit()}}):(f=!0,a||h("form").submit())}(e))},scaled="transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",h(document).on("mousedown touchstart",function(e){var t,a,i,n,o,s,r,l,d,c=h(e.target).closest(".image");h(".z-view").parent().css({"z-index":"1",transform:""}).one(scaled,function(e){h(this).css({"z-index":""}),h(this).off(scaled)}),h(".z-view").remove(),h(".image .fa-search-minus",this).removeClass("fa-search-minus"),h(e.target).is(".fa-search-plus")&&"none"==c.css("transform")&&(h(e.target).addClass("fa-search-minus"),a=w+c.find(".img-input").val(),(t=c.data("upl"))&&(a=t.value),i="",n=2.7*c.width()>h(m).width()?h(m).width()/c.width():2.7,o=c.offset().left-h(m).offset().left,s=h(m).height()-(c.offset().top-h(m).offset().top+c.height()),c.width()*n*1.5>h(m).width()?i="translateX("+(h(m).width()/2-(o+c.width()/2))/n+"px)":(d=(h(m).width()/2-(o+c.width()/2))/n*.1,r=(c.width()*n-c.width())/2,l=o+c.width()+r,d=d+c.width()*n>h(m).width()?0:d,o<r?i="translateX("+((r-o)/n+d)+"px)":h(m).width()<l&&(i="translateX(-"+((l-h(m).width())/n-d)+"px)")),s<0&&(i+=" translateY("+(s-4)+"px)"),c.css({"z-index":"2",transform:"scale("+n+") "+i}),c.one(scaled,function(e){h(this).prepend("<img class='z-view' src='"+a+"'>"),h(this).off(scaled)}))});function k(e,t,a){var i;h(".alert-msg").remove(),e&&(i='<div  class="alert-msg alert alert-'+(t||"success")+' alert-dismissible"><i class="fa fa-check-circle"></i>',i+=e+'<button type="button" class="close" data-dismiss="alert">×</button></div>',"object"==typeof a&&null!=a.parentNode?h(a).after(i):h("#content > .container-fluid,#content > .box").prepend(i))}function g(n){h.ajax({data:{settings:n},type:"post",url:"index.php?route=catalog/product/productsImageManagerSettings"+y("token"),success:function(e){var t,a,i;(e=JSON.parse(e)).error||"modal.html"!==n?e.success?(t="content",a=e.content,void 0!==i&&void 0!==a&&void 0!==t?void 0!==s[t]&&(s[t][a]=i):void 0!==a&&void 0!==t&&(s[t]=a),T(),k(e.success),h("#im_setting_modal").modal("hide")):e.error&&(k(e.error,"danger"),h("#im_setting_modal").modal("hide")):(h("#im_setting_modal").remove(),window.preViewCanvas=_,h("body").append(e.content),h("#im_setting_modal").modal("show"))}})}function T(){var e;"on"===y("content","watermark_status")&&((e=y("content","watermark")).image=new Image,e.image.src=e.src,e.image.onerror=function(){k(" "+y("lang","watermark_not_found"),"danger"),e.image=!1})}h("#pim_settings").click(function(){g("modal.html")}),h(document).on("click","#save_setting",function(e){this.innerHTML='<i class ="fa fa-circle-o-notch fa-spin" ></i>',g(h("#im_setting_modal form").serialize())}),T()}(jQuery);